(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6117],{88090:(e,r,i)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/posts/react/legacy-concurrent",function(){return i(83381)}])},83381:(e,r,i)=>{"use strict";i.r(r),i.d(r,{default:()=>o,useTOC:()=>h});var n=i(86070),t=i(19422),A=i(72522),s=i(24756);let a={src:"/_next/static/media/hero.2da5b12c.webp",height:665,width:893,blurDataURL:"data:image/webp;base64,UklGRkQAAABXRUJQVlA4IDgAAAAQAgCdASoIAAYAAkA4JZgCdLoAAroZsQQAAP7riwj44rtKi7rpTtEAA8ftSiEWRl/jebzWrEAAAA==",blurWidth:8,blurHeight:6},d={src:"/_next/static/media/legcay.d5d5da99.png",height:559,width:727,blurDataURL:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAGCAMAAADJ2y/JAAAACVBMVEXu7u7o6Oj8/Pz19r+0AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAJUlEQVR4nCXKwQkAQBCDQLX/oo/cfoIMIVQJRBFOilbb6b3qywME8gAyn22ZxQAAAABJRU5ErkJggg==",blurWidth:8,blurHeight:6},l={src:"/_next/static/media/legcay.93b5603f.jpg",height:814,width:1218,blurDataURL:"data:image/jpeg;base64,/9j/2wBDAAoKCgoKCgsMDAsPEA4QDxYUExMUFiIYGhgaGCIzICUgICUgMy03LCksNy1RQDg4QFFeT0pPXnFlZXGPiI+7u/v/2wBDAQoKCgoKCgsMDAsPEA4QDxYUExMUFiIYGhgaGCIzICUgICUgMy03LCksNy1RQDg4QFFeT0pPXnFlZXGPiI+7u/v/wgARCAAFAAgDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAf/xAAUAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAACsgP/EABkQAAEFAAAAAAAAAAAAAAAAAAEAERIiQf/aAAgBAQABPwCdmI1f/8QAFBEBAAAAAAAAAAAAAAAAAAAAAP/aAAgBAgEBPwB//8QAFREBAQAAAAAAAAAAAAAAAAAAABH/2gAIAQMBAT8Ar//Z",blurWidth:8,blurHeight:5};var c=i(39942);function h(e){return[{value:"react启动的模式",id:"react启动的模式",depth:2},{value:"不同模式在react运行时的含义",id:"不同模式在react运行时的含义",depth:2},{value:"两种模式函数主要执行过程",id:"两种模式函数主要执行过程",depth:2},{value:"legacy模式",id:"legacy模式",depth:2},{value:"concurrent模式",id:"concurrent模式",depth:2},{value:"两种模式的不同点",id:"两种模式的不同点",depth:2}]}let o=(0,t.e)(function(e){let{toc:r=h(e)}=e,i={code:"code",h2:"h2",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",span:"span",...(0,s.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(i.p,{children:(0,n.jsx)(i.img,{alt:"Legacy Concurrent",placeholder:"blur",src:a})}),"\n",(0,n.jsx)("div",{className:"img-desc",children:"图：Nguyen Nhut"}),"\n",(0,n.jsx)(i.h2,{id:r[0].id,children:r[0].value}),"\n",(0,n.jsx)(i.p,{children:"react有3种模式进入主体函数的入口，我们可以从 react官方文档 使用 Concurrent 模式（实验性）中对比三种模式："}),"\n",(0,n.jsx)(i.pre,{tabIndex:"0","data-language":"plaintext","data-word-wrap":"","data-copy":"",children:(0,n.jsxs)(i.code,{children:[(0,n.jsx)(i.span,{children:(0,n.jsx)(i.span,{children:"* legacy 模式： ReactDOM.render(<App />, rootNode)。这是当前 React app 使用的方式。当前没有计划删除本模式，但是这个模式可能不支持这些新功能。"})}),"\n",(0,n.jsx)(i.span,{children:(0,n.jsx)(i.span,{children:"* blocking 模式： ReactDOM.createBlockingRoot(rootNode).render(<App />)。目前正在实验中。作为迁移到 concurrent 模式的第一个步骤。"})}),"\n",(0,n.jsx)(i.span,{children:(0,n.jsx)(i.span,{children:"* concurrent 模式： ReactDOM.createRoot(rootNode).render(<App />)。目前在实验中，未来稳定之后，打算作为 React 的默认开发模式。这个模式开启了所有的新功能。"})})]})}),"\n",(0,n.jsx)(i.p,{children:"legacy 模式在合成事件中有自动批处理的功能，但仅限于一个浏览器任务。非 React 事件想使用这个功能必须使用 unstable_batchedUpdates。在 blocking 模式和 concurrent 模式下，所有的 setState 在默认情况下都是批处理的。会在开发中发出警告"}),"\n",(0,n.jsx)(i.h2,{id:r[1].id,children:r[1].value}),"\n",(0,n.jsx)(i.p,{children:"legacy模式是我们常用的，它构建dom的过程是同步的，所以在render的reconciler中，如果diff的过程特别耗时，那么导致的结果就是js一直阻塞高优先级的任务(例如用户的点击事件)，表现为页面的卡顿，无法响应。"}),"\n",(0,n.jsx)(i.p,{children:"concurrent Mode是react未来的模式，它用时间片调度实现了异步可中断的任务，根据设备性能的不同，时间片的长度也不一样，在每个时间片中，如果任务到了过期时间，就会主动让出线程给高优先级的任务。这部分将在第15节 scheduler&lane模型 。"}),"\n",(0,n.jsx)(i.h2,{id:r[2].id,children:r[2].value}),"\n",(0,n.jsx)(i.p,{children:(0,n.jsx)(i.img,{placeholder:"blur",src:d})}),"\n",(0,n.jsx)(i.p,{children:"黄色部分是主要任务是创建fiberRootNode和rootFiber，红色部分是创建Update，蓝色部分是调度render阶段的入口函数"}),"\n",(0,n.jsx)(i.p,{children:(0,n.jsx)(i.img,{placeholder:"blur",src:l})}),"\n",(0,n.jsx)(i.h2,{id:r[3].id,children:r[3].value}),"\n",(0,n.jsx)(i.p,{children:"render调用legacyRenderSubtreeIntoContainer，最后createRootImpl会调用到createFiberRoot创建fiberRootNode,然后调用createHostRootFiber创建rootFiber，其中fiberRootNode是整个项目的的根节点，rootFiber是当前应用挂在的节点，也就是ReactDOM.render调用后的根节点"}),"\n",(0,n.jsx)(i.pre,{icon:c.js,tabIndex:"0","data-language":"jsx","data-word-wrap":"","data-copy":"",children:(0,n.jsxs)(i.code,{children:[(0,n.jsx)(i.span,{children:" "}),"\n",(0,n.jsx)(i.span,{children:(0,n.jsx)(i.span,{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"},children:"//最上层的节点是整个项目的根节点fiberRootNode"})}),"\n",(0,n.jsxs)(i.span,{children:[(0,n.jsx)(i.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"ReactDOM."}),(0,n.jsx)(i.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:"render"}),(0,n.jsx)(i.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"(<"}),(0,n.jsx)(i.span,{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"},children:"App"}),(0,n.jsx)(i.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:" />, document."}),(0,n.jsx)(i.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:"getElementById"}),(0,n.jsx)(i.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"("}),(0,n.jsx)(i.span,{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"},children:'"root"'}),(0,n.jsx)(i.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"));"}),(0,n.jsx)(i.span,{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"},children:"//rootFiber"})]}),"\n",(0,n.jsxs)(i.span,{children:[(0,n.jsx)(i.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"ReactDOM."}),(0,n.jsx)(i.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:"render"}),(0,n.jsx)(i.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"(<"}),(0,n.jsx)(i.span,{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"},children:"App"}),(0,n.jsx)(i.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:" />, document."}),(0,n.jsx)(i.span,{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"},children:"getElementById"}),(0,n.jsx)(i.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"("}),(0,n.jsx)(i.span,{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"},children:'"root"'}),(0,n.jsx)(i.span,{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"},children:"));"}),(0,n.jsx)(i.span,{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"},children:"//rootFiber"})]}),"\n",(0,n.jsx)(i.span,{children:" "})]})}),"\n",(0,n.jsx)(i.p,{children:"创建完Fiber节点后，legacyRenderSubtreeIntoContainer调用updateContainer创建创建Update对象挂载到updateQueue的环形链表上，然后执行scheduleUpdateOnFiber调用performSyncWorkOnRoot进入render阶段和commit阶段"}),"\n",(0,n.jsx)(i.h2,{id:r[4].id,children:r[4].value}),"\n",(0,n.jsx)(i.p,{children:"createRoot调用createRootImpl创建fiberRootNode和rootNode\n创建完Fiber节点后，调用ReactDOMRoot.prototype.render执行updateContainer，然后scheduleUpdateOnFiber异步调度performConcurrentWorkOnRoot进入render阶段和commit阶段"}),"\n",(0,n.jsx)(i.h2,{id:r[5].id,children:r[5].value}),"\n",(0,n.jsxs)(i.ol,{children:["\n",(0,n.jsx)(i.li,{children:"createRootImpl中传入的第二个参数不一样 一个是LegacyRoot一个是ConcurrentRoot"}),"\n",(0,n.jsx)(i.li,{children:"requestUpdateLane中获取的lane的优先级不同"}),"\n",(0,n.jsx)(i.li,{children:"在函数scheduleUpdateOnFiber中根据不同优先级进入不同分支，legacy模式进入performSyncWorkOnRoot，concurrent模式会异步调度performConcurrentWorkOnRoot"}),"\n"]})]})},"/posts/react/legacy-concurrent",{filePath:"pages/posts/react/legacy-concurrent/index.mdx",timestamp:1732442721e3,pageMap:A.O,frontMatter:{slug:"react-legacy-concurrent",title:"legacy和concurrent模式",author:"Favori",date:"2021-09-01",hero:"./hero.webp",excerpt:"react-legacy-concurrent"},title:"legacy和concurrent模式"},"undefined"==typeof RemoteContent?h:RemoteContent.useTOC)}},e=>{var r=r=>e(e.s=r);e.O(0,[2195,636,6593,8792],()=>r(88090)),_N_E=e.O()}]);