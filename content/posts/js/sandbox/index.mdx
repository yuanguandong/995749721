---
slug: js-sandbox
title: JSæ²™ç®±sandboxçš„å„ç§å®ç°
author: è¢å®˜ä¸œ
date: 2022-09-18
hero: ./hero.webp
excerpt: æˆ‘ä»¬æŠŠJséš”ç¦»æœºåˆ¶å¸¸å¸¸ç§°ä½œæ²™ç®±
---

<div className={"img-desc"}>å›¾ï¼šPeter Tarka</div>

import Draw from "../../../../src/@narative/gatsby-theme-novela/components/draw";

## withã€å…¨ä»£ç†æ²™ç®±

```js
// ç›‘æ§æ‰§è¡Œä»£ç 
function compileCode(src) {
  src = `with (exposeObj){${src}}`;
  return new Function("exposeObj", src);
}
// ä»£ç†å¯¹è±¡
function proxyObj(originObj) {
  let exposeObj = new Proxy(originObj, {
    has: (target, key) => {
      if (["console", "Math", "Date"].indexOf(key) >= 0) {
        return target[key];
      }
      if (!target.hasOwnProperty(key)) {
        throw new Error(`${target}ä¸Šä¸å­˜åœ¨${key}`);
      }
      return target[key];
    },
  });
  return exposeObj;
}
// åˆ›å»ºæ²™ç›’
function createSandbox(src, obj) {
  let proxy = proxyObj(obj);
  compileCode(src).call(proxy, proxy);
}

const testObj = {
  value: 1,
  a: {
    b: 2,
  },
  c: "3",
};
const c = "c";
createSandbox(`value='32323';console.log(c);`, testObj);
```

## å¿«ç…§ Snapshot æ²™ç®±

æ ¸å¿ƒåŸç†æ˜¯æ¿€æ´»å½“å‰æ²™ç®±æ—¶æŠŠå‰å®¿ä¸»ç¯å¢ƒçš„å…¨å±€å˜é‡å¤‡ä»½ä¸€ä¸‹ï¼Œå¹¶æŠŠä¸Šä¸€æ¬¡å¯¹è¯¥æ²™ç®±åšçš„æ›´æ”¹æ¢å¤ä¸€ä¸‹ï¼ˆè‹¥å­˜åœ¨ï¼‰

å¤±æ´»æ—¶æ‰¾å‡ºå½“æ¬¡æ²™ç®±å’Œå¤‡ä»½çš„å…¨å±€å˜é‡ä¸åŒçš„å±æ€§ï¼Œå­˜å‚¨ä¸€ä¸‹ï¼Œå¹¶æŠŠå­˜å‚¨çš„å®¿ä¸»ç¯å¢ƒæ¢å¤ä¸€ä¸‹

å“ˆï¼ŒåŒç¼“å­˜ç­–ç•¥

```js
class SnapshotSandBox {
  constructor(name) {
    this.modifyMap = {}; // å­˜æ”¾ä¿®æ”¹çš„å±æ€§
    this.windowSnapshot = {};
  }
  active() {
    // ç¼“å­˜activeçŠ¶æ€çš„æ²™ç®±
    this.windowSnapshot = {};
    for (const item in window) {
      this.windowSnapshot[item] = window[item];
    }

    Object.keys(this.modifyMap).forEach((p) => {
      window[p] = this.modifyMap[p];
    });
  }
  inactive() {
    for (const item in window) {
      if (this.windowSnapshot[item] !== window[item]) {
        // è®°å½•å˜æ›´
        this.modifyMap[item] = window[item];
        // è¿˜åŸwindow
        window[item] = this.windowSnapshot[item];
      }
    }
  }
}
window.a = "1";
const diffSandbox = new SnapshotSandBox();
diffSandbox.active(); // æ¿€æ´»æ²™ç®±
debugger;
window.a = "0";
console.log("å¼€å¯æ²™ç®±ï¼š", window.a);
diffSandbox.inactive(); //å¤±æ´»æ²™ç®±
debugger;
console.log("å¤±æ´»æ²™ç®±ï¼š", window.a);
diffSandbox.active(); // é‡æ–°æ¿€æ´»
debugger;
console.log("å†æ¬¡æ¿€æ´»", window.a);
```

è¿™ç§æ–¹å¼ä¹Ÿæ— æ³•æ”¯æŒå¤šå®ä¾‹ï¼Œå› ä¸ºè¿è¡ŒæœŸé—´æ‰€æœ‰çš„å±æ€§éƒ½æ˜¯ä¿å­˜åœ¨ window ä¸Šçš„ã€‚

## ä»£ç† Proxy æ²™ç®±

### å•å®ä¾‹

```js
class LegacySandBox {
  addedPropsMapInSandbox = new Map();
  modifiedPropsOriginalValueMapInSandbox = new Map();
  currentUpdatedPropsValueMap = new Map();
  proxyWindow;
  setWindowProp(prop, value, toDelete = false) {
    if (value === undefined && toDelete) {
      delete window[prop];
    } else {
      window[prop] = value;
    }
  }
  active() {
    this.currentUpdatedPropsValueMap.forEach((value, prop) =>
      this.setWindowProp(prop, value)
    );
  }
  inactive() {
    this.modifiedPropsOriginalValueMapInSandbox.forEach((value, prop) =>
      this.setWindowProp(prop, value)
    );
    this.addedPropsMapInSandbox.forEach((_, prop) =>
      this.setWindowProp(prop, undefined, true)
    );
  }
  constructor() {
    const fakeWindow = Object.create(null);
    this.proxyWindow = new Proxy(fakeWindow, {
      set: (target, prop, value, receiver) => {
        const originalVal = window[prop];
        if (!window.hasOwnProperty(prop)) {
          this.addedPropsMapInSandbox.set(prop, value);
        } else if (!this.modifiedPropsOriginalValueMapInSandbox.has(prop)) {
          this.modifiedPropsOriginalValueMapInSandbox.set(prop, originalVal);
        }
        this.currentUpdatedPropsValueMap.set(prop, value);
        window[prop] = value;
      },
      get: (target, prop, receiver) => {
        return target[prop];
      },
    });
  }
}
// éªŒè¯ï¼š
let legacySandBox = new LegacySandBox();
legacySandBox.active();
legacySandBox.proxyWindow.city = "Beijing";
console.log("window.city-01:", window.city);
legacySandBox.inactive();
console.log("window.city-02:", window.city);
legacySandBox.active();
console.log("window.city-03:", window.city);
legacySandBox.inactive();
// è¾“å‡ºï¼š
// window.city-01: Beijing
// window.city-02: undefined
// window.city-03: Beijing
```

### å¤šå®ä¾‹

```js
class MultipleProxySandbox {
  active() {
    this.sandboxRunning = true;
  }
  inactive() {
    this.sandboxRunning = false;
  }
  constructor() {
    const rawWindow = window;
    const fakeWindow = {};
    const proxy = new Proxy(fakeWindow, {
      set: (target, prop, value) => {
        if (this.sandboxRunning) {
          target[prop] = value;
          return true;
        }
      },
      get: (target, prop) => {
        // å¦‚æœfakeWindowé‡Œé¢æœ‰ï¼Œå°±ä»fakeWindowé‡Œé¢å–ï¼Œå¦åˆ™ï¼Œå°±ä»å¤–éƒ¨çš„windowé‡Œé¢å–
        let value = prop in target ? target[prop] : rawWindow[prop];
        return value;
      },
    });
    this.proxy = proxy;
  }
}

const context = { document: window.document };

const newSandBox1 = new MultipleProxySandbox("ä»£ç†æ²™ç®±1", context);
newSandBox1.active();
const proxyWindow1 = newSandBox1.proxy;

const newSandBox2 = new MultipleProxySandbox("ä»£ç†æ²™ç®±2", context);
newSandBox2.active();
const proxyWindow2 = newSandBox2.proxy;
console.log(
  "å…±äº«å¯¹è±¡æ˜¯å¦ç›¸ç­‰",
  window.document === proxyWindow1.document,
  window.document === proxyWindow2.document
);

proxyWindow1.a = "1"; // è®¾ç½®ä»£ç†1çš„å€¼
proxyWindow2.a = "2"; // è®¾ç½®ä»£ç†2çš„å€¼
window.a = "3"; // è®¾ç½®windowçš„å€¼
console.log("æ‰“å°è¾“å‡ºçš„å€¼", proxyWindow1.a, proxyWindow2.a, window.a);

newSandBox1.inactive();
newSandBox2.inactive(); // ä¸¤ä¸ªæ²™ç®±éƒ½å¤±æ´»

proxyWindow1.a = "4"; // è®¾ç½®ä»£ç†1çš„å€¼
proxyWindow2.a = "4"; // è®¾ç½®ä»£ç†2çš„å€¼
window.a = "4"; // è®¾ç½®windowçš„å€¼
console.log("å¤±æ´»åæ‰“å°è¾“å‡ºçš„å€¼", proxyWindow1.a, proxyWindow2.a, window.a);

newSandBox1.active();
newSandBox2.active(); // å†æ¬¡æ¿€æ´»

proxyWindow1.a = "4"; // è®¾ç½®ä»£ç†1çš„å€¼
proxyWindow2.a = "4"; // è®¾ç½®ä»£ç†2çš„å€¼
window.a = "4"; // è®¾ç½®windowçš„å€¼
console.log("å¤±æ´»åæ‰“å°è¾“å‡ºçš„å€¼", proxyWindow1.a, proxyWindow2.a, window.a);
```

å¯ä»¥çœ‹å‡ºæœ€åä¸€ç§å®ç°æ˜¯æœ€ä¼˜å®ç°ï¼Œæ—¢æ²¡æœ‰æ“ä½œ window,åˆèƒ½å®ç°å¤šå®ä¾‹ï¼Œä»£ç åˆç²¾ç®€ï¼Œé€šä¿—æ˜“æ‡‚ ğŸ‘ğŸ»
