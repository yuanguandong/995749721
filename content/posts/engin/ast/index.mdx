---
slug: engin-ast
title: JavaScript AST æŠ½è±¡è¯­æ³•æ ‘
author: è¢å®˜ä¸œ
date: 2020-08-02
hero: ./hero.webp
excerpt: æºä»£ç çš„æŠ½è±¡è¯­æ³•ç»“æ„çš„æ ‘çŠ¶è¡¨ç°å½¢å¼
---

<div className={"img-desc"}>å›¾ï¼šMako Tsereteli</div>

## ç®€ä»‹

ASTï¼ˆAbstract Syntax Treeï¼ŒæŠ½è±¡è¯­æ³•æ ‘ï¼‰åœ¨ [Wikipedia](https://link.zhihu.com/?target=https%3A//en.wikipedia.org/wiki/Abstract_syntax_tree) çš„å®šä¹‰å¦‚ä¸‹ï¼š

> In computer science, an abstract syntax tree (AST), or just syntax tree, is a tree representation of the abstract syntactic structure of source code written in a programming language.

æŒ‡çš„æ˜¯ï¼šæºä»£ç çš„æŠ½è±¡è¯­æ³•ç»“æ„çš„æ ‘çŠ¶è¡¨ç°å½¢å¼

## ç¼–è¯‘åŸç†

å…ˆå›é¡¾ä¸‹ç¼–è¯‘åŸç†çš„å‡ å¤§è¿‡ç¨‹ï¼š

```
**è¯æ³•åˆ†æ**   ===>   å•è¯ä¸è®°å·ã€æ­£åˆ™è¡¨è¾¾å¼ã€æœ‰é™è‡ªåŠ¨æœºã€ä»æ­£åˆ™è¡¨è¾¾å¼åˆ°æœ‰é™è‡ªåŠ¨æœºçš„è½¬æ¢ã€è¯æ³•åˆ†æå™¨çš„å®ç°
        â”‚â”‚
    **è¯­æ³•åˆ†æ**   ===>   ä¸Šä¸‹æ–‡æ— å…³æ–‡æ³•ã€é€’å½’ä¸‹é™åˆ†æã€LR åˆ†æã€é”™è¯¯å¤„ç†ã€è¯­æ³•åˆ†æå™¨è‡ªåŠ¨ç”Ÿæˆ
        â”‚â”‚
    **è¯­ä¹‰åˆ†æ**   ===>   ç±»å‹ç³»ç»Ÿã€å±æ€§æ–‡æ³•ã€è¯­æ³•åˆ¶å¯¼ç¿»è¯‘ã€ç¬¦å·è¡¨ç®¡ç†ã€æŠ½è±¡è¯­æ³•æ ‘ã€çº¿æ€§ä¸­é—´è¡¨ç¤ºã€å›¾ä¸­é—´è¡¨ç¤º
        â”‚â”‚
  **ä¸­é—´ä»£ç ç”Ÿæˆ**   ===>   å˜é‡åœ°å€åˆ†é…ã€ç®—æœ¯è¡¨è¾¾å¼ç¿»è¯‘ã€å¸ƒå°”è¡¨è¾¾å¼ç¿»è¯‘ã€æ•°ç»„ã€ç»“æ„ä½“å’Œå­—ç¬¦ä¸²çš„ç¿»è¯‘ã€æ§åˆ¶æµçš„ç¿»è¯‘ã€å‡½æ•°è°ƒç”¨çš„ç¿»è¯‘
        â”‚â”‚
**ç›®æ ‡ä»£ç ä¼˜åŒ–ä¸ç”Ÿæˆ**   ===>   ç›®æ ‡ä½“ç³»ç»“æ„ã€æ ‘åŒ¹é…ä»£ç ç”Ÿæˆã€åŸºäºåŠ¨æ€è§„åˆ’çš„ä»£ç ç”Ÿæˆã€å¯„å­˜å™¨åˆ†é…ã€æŒ‡ä»¤è°ƒåº¦ã€æ§åˆ¶æµåˆ†æã€æ•°æ®æµåˆ†æã€æ­»ä»£ç åˆ é™¤ã€å¸¸é‡ä¼ æ’­ã€æ‹·è´ä¼ æ’­ã€é™æ€å•èµ‹å€¼å½¢å¼
```

JavaScript æ˜¯ä¸€é—¨è§£é‡Šå‹è¯­è¨€ï¼Œä½†å…¶åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä»ç„¶éœ€è¦å³æ—¶ç¼–è¯‘ï¼ˆJITï¼‰ï¼Œå…¶ç¼–è¯‘è¿‡ç¨‹ä¹Ÿéµå¾ªè¿™äº›æµç¨‹ï¼š

```
**åˆ†è¯ï¼è¯æ³•åˆ†æ**   ===>   æŠŠå­—ç¬¦ä¸²åˆ†è§£æˆæœ‰æ„ä¹‰çš„ä»£ç å—ï¼Œè¿™äº›ä»£ç å—è¢«ç§°ä¸ºè¯æ³•å•å…ƒ
      â”‚â”‚
**è§£æï¼è¯­æ³•åˆ†æ**   ===>   è¯æ³•å•å…ƒæµï¼ˆæ•°ç»„ï¼‰è½¬æ¢æˆä¸€ä¸ªç”±å…ƒç´ é€çº§åµŒå¥—æ‰€ç»„æˆçš„ä»£è¡¨äº†ç¨‹åºè¯­æ³•ç»“æ„çš„æ ‘ï¼Œå³ AST
      â”‚â”‚
  **ä»£ç ç”Ÿæˆ**   ===>   å°† AST è½¬æ¢ä¸ºå¯æ‰§è¡Œä»£ç 
```

æ€»ç»“ä¸€ä¸‹ï¼šé€šè¿‡ Parser æŠŠä»£ç è½¬åŒ–ä¸ºæŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰ï¼Œè¯¥æ ‘å®šä¹‰äº†ä»£ç çš„ç»“æ„ï¼Œé€šè¿‡å¯¹æ ‘çš„å¤„ç†ï¼Œèƒ½å®ç°å¯¹ä»£ç çš„åˆ†æã€ä¼˜åŒ–ç­‰æ“ä½œã€‚

## JavaScript è¯æ³•è§£æ

é€šè¿‡åˆ†ææ¯è¡Œä»£ç å­—ç¬¦ä¸²ï¼Œé€šè¿‡è¯†åˆ«å…³é”®å­—æ¥åˆ¤æ–­æŸå¥ä»£ç æ˜¯ä»€ä¹ˆè¡¨è¾¾å¼ç±»å‹ï¼Œç„¶åæŠŠè¿™äº›ä¿¡æ¯ç”Ÿæˆ AST è¯­æ³•æ ‘

```js
if (b === 1) {
  a = 2;
  alert(a);
}
```

è¯æ³•åˆ†ææ€ç»´æŠ½è±¡å¦‚å›¾

<img src="./ast.jpg" />{" "}

## JavaScript è¯­æ³•è§£æ

åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œä»£ç ä¼šè¢«æ˜ å°„ä¸º ASTï¼Œé‚£ä¹ˆå°±å¯ä»¥é€šè¿‡ AST å¯¹ä»£ç è¿›è¡Œåˆ†æã€è½¬æ¢ã€‚åƒ webpackã€babelã€eslint ç­‰æ¶‰åŠä»£ç åˆ†æçš„å·¥å…·ç±»åº“ï¼Œå…¶èƒŒåéƒ½æœ‰ AST çš„å½±å­ã€‚

å…ˆçœ‹çœ‹ AST é•¿ä»€ä¹ˆæ ·ï¼Œé€šè¿‡ [AST Explorer](https://astexplorer.net/) æˆ–è€…[Parser](https://esprima.org/demo/parse.html)å¯ä»¥å®æ—¶è§£æå’ŒæŸ¥çœ‹ JavaScript çš„ ASTã€‚

```js
const a = 1;
```

å¯¹åº”çš„ AST

```json
{
  "type": "Program",
  "body": [
    {
      "type": "VariableDeclaration",
      "declarations": [
        {
          "type": "VariableDeclarator",
          "id": {
            "type": "Identifier",
            "name": "a"
          },
          "init": {
            "type": "Literal",
            "value": 1,
            "raw": "1"
          }
        }
      ],
      "kind": "const"
    }
  ],
  "sourceType": "script"
}
```

AST çš„æ ¼å¼æ¯ç§ Parser éƒ½æœ‰å„è‡ªçš„æ ‡å‡†ï¼Œ[Esprima](https://docs.esprima.org/en/4.0/syntax-tree-format.html) çš„è¯­æ³•æ ‘ç»“æ„æ–‡æ¡£ Syntax Tree Formatï¼Œä¸‹é¢æ˜¯ type çš„ç±»å‹åˆ—è¡¨ã€‚

```ts
type Expression =
  | ThisExpression
  | Identifier
  | Literal
  | ArrayExpression
  | ObjectExpression
  | FunctionExpression
  | ArrowFunctionExpression
  | ClassExpression
  | TaggedTemplateExpression
  | MemberExpression
  | Super
  | MetaProperty
  | NewExpression
  | CallExpression
  | UpdateExpression
  | AwaitExpression
  | UnaryExpression
  | BinaryExpression
  | LogicalExpression
  | ConditionalExpression
  | YieldExpression
  | AssignmentExpression
  | SequenceExpression;
```

## JavaScript Parser

ä»‹ç»å®Œ AST æ ‘ï¼Œä¸‹é¢åˆ—ä¸¾å¸¸ç”¨çš„ JavaScript Parser

- [Esprima](https://link.zhihu.com/?target=http%3A//esprima.org/)
- [UglifyJS2](https://link.zhihu.com/?target=https%3A//github.com/mishoo/UglifyJS2)
- [Traceur](https://link.zhihu.com/?target=https%3A//github.com/google/traceur-compiler)
- [acorn](https://link.zhihu.com/?target=https%3A//github.com/acornjs/acorn)
- [espree eslint](https://link.zhihu.com/?target=https%3A//github.com/eslint/espree)
- [Shift](https://link.zhihu.com/?target=https%3A//github.com/shapesecurity/shift-parser-js)

å„ä¸ª parser çš„é€Ÿåº¦å¯¹æ¯”å¯ä»¥å‚è§ Speed Comparison

## åº”ç”¨

AST çš„åº”ç”¨å¾ˆå¹¿ï¼Œä»æŠ€æœ¯è§’åº¦å‡ºå‘ï¼Œæ‰€æœ‰æ¶‰åŠå¯¹ä»£ç å¤„ç†çš„åœºæ™¯ï¼ŒAST éƒ½æœ‰å…¶ç”¨æ­¦ä¹‹åœ°ã€‚

ç¼–è¯‘å™¨ã€ä»£ç å‹ç¼©ã€ä»£ç æ··æ·†ã€ä»£ç ä¼˜åŒ–ï¼Œæ‰€æœ‰çš„ lintï¼ˆä¸ä»…ä»…æ˜¯ JavaScriptï¼‰ï¼Œæ‰€æœ‰çš„æ‰“åŒ…æ„å»ºå·¥å…·åŠå…¶æ’ä»¶ï¼ŒåŒ…æ‹¬ webpackã€rollupã€parcelã€browserify ç­‰...

ğŸ»