---
slug: other-terminal
title: åšä¸€ä¸ªweb termianl
author: è¢å®˜ä¸œ
date: 2022-07-17
hero: ./hero.png
excerpt: å‰ç«¯react, åç«¯nodejs, ç›´æ¥å¯ç”¨ç‰ˆweb termianl
---

<div className={"img-desc"}>å›¾ï¼šTobias</div>

import Draw from "../../../../src/@narative/gatsby-theme-novela/components/draw";

æœ€è¿‘å…¬å¸é¡¹ç›®è¦ç”¨åˆ° web termianl, å…ˆæå‰åœ¨å®¶é‡Œåšä¸€ä¸ª ğŸ¶

## æ•ˆæœå›¾

<img src="./1.png" />
è‡ªé€‚åº”å®¹å™¨ã€å¸¦æœç´¢ã€ä¸»é¢˜ç¾åŒ–

## å‡†å¤‡

éœ€æ±‚æ˜¯è‡ªåŠ¨åŒ–æµ‹è¯•çš„æ—¥å¿—ï¼Œè¦å®æ—¶çš„å±•ç°åœ¨å‰ç«¯ï¼Œæ‰€ä»¥å°‘ä¸äº† webSocket

åœ¨å‰ç«¯éœ€è¦æœ‰ä¸ªç»ˆç«¯èƒ½æ˜¾ç¤ºå‡ºæ¥ï¼Œä¹Ÿæœ‰å¯èƒ½åç»­ä¼šéœ€è¦åœ¨å‰ç«¯ç›´æ¥æ“ä½œæœåŠ¡ç«¯çš„ç»ˆç«¯

æ‰€ä»¥ï¼Œä¸€æ¬¡æ€§åˆ°ä½ï¼Œç›´æ¥åšä¸ª web termianl

ç”¨åˆ°çš„åº“æœ‰ xtermã€ahooks ç­‰

å…·ä½“è¿‡ç¨‹å†™åœ¨ä»£ç æ³¨é‡Šé‡Œï¼Œä¸€çœ‹å°±æ‡‚

ä¸Šä»£ç  ğŸ‘‡

## å®¢æˆ·ç«¯

```tsx
import { useEffect, useLayoutEffect, useRef } from "react";
import { Terminal } from "xterm";
import { AttachAddon } from "xterm-addon-attach";
import { FitAddon } from "xterm-addon-fit";
import { SearchAddon } from "xterm-addon-search";
import { WebLinksAddon } from "xterm-addon-web-links";
import { AdventureTime } from "xterm-theme";
import { useSize, useWebSocket } from "ahooks";
import "xterm/css/xterm.css";
import "./index.less";

const socketURL = "ws://127.0.0.1:4000/socket";
const height = 500;
const fontSize = 12;

export default function HomePage() {
  const termRef = useRef<any>(null);
  const containerRef = useRef<any>(null);
  const insDomRef = useRef<any>(null);
  // ç›‘å¬å®¹å™¨å°ºå¯¸ï¼Œç”¨äºåšè‡ªé€‚åº”
  const size = useSize(containerRef);

  // ç›´æ¥ä½¿ç”¨å°è£…å¥½çš„useWebSocket
  const {
    readyState,
    sendMessage,
    latestMessage,
    disconnect,
    connect,
    webSocketIns,
  } = useWebSocket(socketURL);

  useEffect(() => {
    if (!webSocketIns) {
      return;
    }

    // åˆ›å»ºç»ˆç«¯å®ä¾‹
    var term = new Terminal({
      fontFamily: 'Menlo, Monaco, "Courier New", monospace',
      fontWeight: 400,
      fontSize,
      theme: AdventureTime,
      rows: Math.floor(height / (fontSize + 2)),
    });

    // æ·»åŠ ç»ˆç«¯æ’ä»¶
    // An addon for xterm.js that enables attaching to a web socket
    const attachAddon = new AttachAddon(webSocketIns as WebSocket);
    // è‡ªé€‚åº”å®¹å™¨æ’ä»¶
    const fitAddon = new FitAddon();
    // æœç´¢æ’ä»¶
    const searchAddon = new SearchAddon();
    // è¶…é“¾æ¥æ˜¾ç¤ºæ’ä»¶
    const webLinksAddon = new WebLinksAddon();

    term.loadAddon(attachAddon);
    term.loadAddon(fitAddon);
    term.loadAddon(searchAddon);
    term.loadAddon(webLinksAddon);

    // æŠŠç¤ºä¾‹æŒ‚è½½ç»™ref
    termRef.current = {
      term,
      searchAddon,
      fitAddon,
    };

    // render ç»ˆç«¯åˆ°å®¹å™¨
    term.open(insDomRef.current);
    // é€‚ç”¨å®¹å™¨ï¼ˆå‘ç°åªèƒ½é€‚åº”å®½åº¦ï¼‰
    fitAddon.fit();

    return () => {
      //ç»„ä»¶å¸è½½ï¼Œæ¸…é™¤ Terminal å®ä¾‹
      term.dispose();
      termRef.current = null;
    };
  }, [webSocketIns]);

  // å“åº”å®¹å™¨å°ºå¯¸å‰¯ä½œç”¨
  useLayoutEffect(() => {
    if (!size) {
      return;
    }
    // æƒ³åšå“åº”å¼é«˜åº¦ã€ä¸è¿‡è¿™ä¸ªæ–¹æ³•è°ƒç”¨æŠ¥é”™è¯´rowsåªèƒ½åœ¨æ„é€ å‡½æ•°é‡ŒæŒ‡å®šï¼Œæš‚æ—¶æ²¡æƒ³åˆ°å¥½çš„åŠæ³•å¤„ç†
    // termRef.current.term.setOption(
    //   "rows",
    //   Math.floor(size.height / (fontSize + 2))
    // );
    termRef.current?.fitAddon?.fit();
  }, [size]);

  return (
    <>
      <input
        type="text"
        placeholder="æŸ¥è¯¢å…³é”®å­—"
        onChange={(e) => termRef.current.searchAddon?.findNext(e.target.value)}
        style={{ marginBottom: 10 }}
      />
      <div style={{ height, width: "100%" }} ref={containerRef}>
        <div
          style={{
            background: "#1F1D45",
            borderRadius: 10,
            overflow: "hidden",
            padding: 10,
          }}
          ref={insDomRef}
        />
      </div>
    </>
  );
}
```
å®šåˆ¶ä¸‹æ»šåŠ¨æ¡ï¼Œè®©å…¶é€æ˜
```less
.xterm .xterm-viewport {
  &::-webkit-scrollbar {
    width: 10px;
    height: 10px;
  }

  &::-webkit-scrollbar-track {
    background-color: transparent;
    border-radius: 10px;
  }

  &::-webkit-scrollbar-thumb {
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
  }
}
```

## æœåŠ¡ç«¯

```js
const express = require("express");
const expressWs = require("express-ws");
const pty = require("node-pty");
const os = require("os");
const example = require("./data");
const app = express();
const port = 4000;

expressWs(app);

// åˆ›å»ºç»ˆç«¯å­è¿›ç¨‹
const shell = os.platform() === "win32" ? "powershell.exe" : "bash";
const term = pty.spawn(shell, ["--login"], {
  name: "xterm-color",
  cols: 80,
  rows: 24,
  cwd: process.env.HOME,
  env: process.env,
});

// æš´éœ²socket
app.ws("/socket", (ws, req) => {
  term.write(example);
  // ç¼–ç è½¬æ¢
  term.onData(function (data) {
    ws.send(data);
  });
  // æ”¶åˆ°è¾“å…¥
  ws.on("message", (data) => {
    term.write(data);
  });
  ws.on("close", function () {
    term.kill();
  });
});

app.listen(port, "127.0.0.1", () => {
  console.log(`Example app listening on port ${port}`);
});
```
